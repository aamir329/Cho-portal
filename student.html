<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Crescent Heights Oyo – Student Portal</title>

<style>
body{
  font-family:Arial,sans-serif;
  background:#162539;
  color:#fff;
  text-align:center;
  padding:30px;
}

.container{
  background:#fff;
  color:#000;
  padding:25px;
  border-radius:8px;
  max-width:600px;
  margin:auto;
}

input,button{
  width:100%;
  padding:10px;
  margin:8px 0;
  border-radius:4px;
  border:1px solid #ccc;
}

button{
  background:#0b3c5d;
  color:#fff;
  border:none;
  cursor:pointer;
}

button:hover{
  background:#145a86;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}

th,td{
  border:1px solid #ccc;
  padding:8px;
  text-align:center;
}

th{
  background:#0b3c5d;
  color:#fff;
}

img{
  width:120px;
  border-radius:6px;
  margin:10px 0;
}

/* Modal Styles */
.modal {
  display: none; 
  position: fixed; 
  z-index: 100; 
  left: 0;
  top: 0;
  width: 100%; 
  height: 100%; 
  overflow: auto;
  background-color: rgba(0,0,0,0.7); 
}

.modal-content {
  background-color: #fff;
  color: #000;
  margin: 10% auto;
  padding: 20px;
  border-radius: 8px;
  max-width: 500px;
  text-align: left;
}

.close {
  color: #0b3c5d;
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}

.close:hover {
  color: #145a86;
}
</style>
</head>

<body>

<h2>Crescent Heights Oyo – Student Portal</h2>

<div class="container">

  <input id="matricInput" placeholder="Enter Matric Number">
  <button onclick="checkResult()">Check Result</button>

  <div id="resultArea" style="display:none; margin-top:20px;">

    <h3 id="studentName"></h3>
    <p id="studentClass"></p>
    <p id="studentSession"></p>

    <img id="studentPassport">

    <table id="resultTable"></table>

    <!-- NEW BUTTONS -->
    <button onclick="openProfileModal()" style="margin-top:15px;">View Profile</button>
    <button onclick="downloadResults()" style="margin-top:10px;">Download Results</button>

  </div>

</div>

<!-- Modal Structure -->
<div id="profileModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeProfileModal()">&times;</span>
    <h3 id="modalName"></h3>
    <p id="modalMatric"></p>
    <p id="modalClass"></p>
    <p id="modalSession"></p>
    <img id="modalPassport" style="width:100px; margin-top:10px;">
  </div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyDyGAAiybGdSQZvsJnzK46fUtCMmcVwhP0",
  authDomain: "crescent-heights-oyo.firebaseapp.com",
  projectId: "crescent-heights-oyo",
  storageBucket: "crescent-heights-oyo.appspot.com",
  messagingSenderId: "1067062273531",
  appId: "1:1067062273531:web:c90a74569e8fb2d18c175e"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentStudent = null; // store current student data

window.checkResult = async function(){

  const matric = matricInput.value.trim();

  if(!matric){
    alert("Enter matric number");
    return;
  }

  const q = query(collection(db,"students"), where("matric","==",matric));
  const snapshot = await getDocs(q);

  if(snapshot.empty){
    alert("Student not found");
    return;
  }

  snapshot.forEach(docSnap=>{
    const s = docSnap.data();
    currentStudent = s; // save for modal use

    studentName.innerText = s.name;
    studentClass.innerText = "Class: "+s.class;
    studentSession.innerText = s.term+" | "+s.session;

    studentPassport.src = s.passport;

    resultTable.innerHTML="<tr><th>Subject</th><th>Score</th></tr>";

    s.results.forEach(r=>{
      resultTable.innerHTML+=`
        <tr>
          <td>${r.subject}</td>
          <td>${r.score}</td>
        </tr>
      `;
    });

    resultArea.style.display="block";
  });

}

// OPEN PROFILE MODAL
window.openProfileModal = function(){
  if(!currentStudent){
    alert("No student selected");
    return;
  }

  modalName.innerText = currentStudent.name;
  modalMatric.innerText = "Matric Number: " + currentStudent.matric;
  modalClass.innerText = "Class: " + currentStudent.class;
  modalSession.innerText = currentStudent.term + " | " + currentStudent.session;
  modalPassport.src = currentStudent.passport;

  profileModal.style.display = "block";
}

// CLOSE PROFILE MODAL
window.closeProfileModal = function(){
  profileModal.style.display = "none";
}

// DOWNLOAD RESULTS BUTTON
window.downloadResults = function(){
  if(!currentStudent){
    alert("No student selected");
    return;
  }

  const matric = currentStudent.matric;
  const name = currentStudent.name;
  const studentClassText = "Class: " + currentStudent.class;
  const sessionText = currentStudent.term + " | " + currentStudent.session;

  if(resultTable.rows.length <= 1){
    alert("No results to download");
    return;
  }

  let csvContent = "Name,Class,Session\n";
  csvContent += `${name},${studentClassText},${sessionText}\n\n`;
  csvContent += "Subject,Score\n";

  for(let i=1; i<resultTable.rows.length; i++){
    const row = resultTable.rows[i];
    csvContent += `${row.cells[0].innerText},${row.cells[1].innerText}\n`;
  }

  const blob = new Blob([csvContent], { type: "text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `${matric}_results.csv`;
  link.click();
}

// Close modal if user clicks outside content
window.onclick = function(event) {
  if (event.target == profileModal) {
    profileModal.style.display = "none";
  }
}

</script>

</body>
</html>
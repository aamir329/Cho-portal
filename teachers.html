<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Crescent Heights Oyo ‚Äì Teachers Portal</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  font-family:"Segoe UI",Arial,sans-serif;
  background:#162539;
}
.header{
  background:#0b3c5d;
  color:#fff;
  padding:15px 25px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.wrapper{display:flex}
.sidebar{
  width:240px;
  background:#082c44;
  min-height:100vh;
  color:#fff;
}
.sidebar h3{
  text-align:center;
  padding:20px;
  border-bottom:1px solid rgba(255,255,255,.2);
}
.sidebar a{
  display:block;
  padding:14px 20px;
  color:#fff;
  cursor:pointer;
  border-bottom:1px solid rgba(255,255,255,.08);
}
.sidebar a:hover{background:#0b3c5d}
.content{flex:1;padding:25px}
.card{
  background:#fff;
  padding:20px;
  margin-bottom:25px;
  border-radius:6px;
  box-shadow:0 2px 6px rgba(0,0,0,.1);
}
input,select,button{
  padding:10px;
  margin:5px 0;
  border:1px solid #ccc;
  border-radius:4px;
  width:100%;
}
button{
  background:#0b3c5d;
  color:#fff;
  border:none;
  cursor:pointer;
}
button:hover{background:#145a86}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}
th,td{
  border:1px solid #ccc;
  padding:8px;
  text-align:center;
}
th{background:#0b3c5d;color:#fff}
.hidden{display:none}
.stat-box{
  display:inline-block;
  width:23%;
  background:#0b3c5d;
  color:white;
  padding:15px;
  margin:5px;
  border-radius:6px;
  text-align:center;
}
.top-student{
  background:#f2f2f2;
  padding:10px;
  margin:5px 0;
  border-left:4px solid #0b3c5d;
}
.passport{
  width:40px;
  height:40px;
  border-radius:50%;
  object-fit:cover;
}

/* Modal Styles */
.modal {
  display: none; 
  position: fixed; 
  z-index: 100; 
  left: 0;
  top: 0;
  width: 100%; 
  height: 100%; 
  overflow: auto;
  background-color: rgba(0,0,0,0.7); 
}
.modal-content {
  background-color: #fff;
  color: #000;
  margin: 5% auto;
  padding: 20px;
  border-radius: 8px;
  max-width: 500px;
  text-align: left;
}
.close {
  color: #0b3c5d;
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}
.close:hover {
  color: #145a86;
}
#downloadBtn{
  margin-top:10px;
}
.term-warning{
  background:#fdd;
  color:#900;
  padding:5px 10px;
  border-radius:4px;
  margin-top:10px;
  font-weight:bold;
}
</style>
</head>

<body>

<script>
if(localStorage.getItem("teacherLoggedIn") !== "yes"){
  window.location.href="login.html";
}
</script>

<div class="header">
  <h2>Crescent Heights Oyo ‚Äì Teachers Portal</h2>
  <button onclick="logout()">Logout</button>
</div>

<div class="wrapper">

  <div class="sidebar">
    <h3>Teacher Menu</h3>
    <a onclick="show('dashboard')">Dashboard</a>
    <a onclick="show('manage')">Manage Students</a>
    <a onclick="show('create')">Create Student</a>
    <a onclick="show('results')">Add Result</a>
  </div>

  <div class="content">

    <div id="dashboard" class="card">
      <h3>Dashboard Overview</h3>
      <div class="stat-box"><h2 id="totalStudents">0</h2><p>Total Students</p></div>
      <div class="stat-box"><h2 id="totalClasses">0</h2><p>Total Classes</p></div>
      <div class="stat-box"><h2 id="totalResults">0</h2><p>Total Results</p></div>
      <div class="stat-box"><h2>2025/2026</h2><p>Session</p></div>

      <h3>üèÜ Top 3 Students</h3>
      <div id="topStudents"></div>

      <h3>üìä Performance Chart</h3>
      <canvas id="performanceChart"></canvas>
    </div>

    <div id="manage" class="card hidden">
      <h3>Manage Students</h3>
      <input id="searchBox" placeholder="Search student">
      <table id="studentTable"></table>
    </div>

    <div id="create" class="card hidden">
      <h3>Create Student</h3>
      <input id="cName" placeholder="Student Name">
      <input id="cClass" placeholder="Class (JSS1)">
      <input type="file" id="cPassport" accept="image/*">
      <button onclick="createStudent()">Create Student</button>
      <p id="createdMatric"></p>
    </div>

    <div id="results" class="card hidden">
      <h3>Add Result</h3>
      <input id="rMatric" placeholder="Matric Number">
      <input id="rSubject" placeholder="Subject">
      <input type="number" id="rScore" placeholder="Score">
      <select id="rTerm">
        <option>First Term</option>
        <option>Second Term</option>
        <option>Third Term</option>
      </select>
      <button onclick="addResult()">Add Result</button>
    </div>

  </div>
</div>

<!-- Modal for Viewing Student -->
<div id="profileModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeProfileModal()">&times;</span>
    <h3 id="modalName"></h3>
    <p id="modalMatric"></p>
    <p id="modalClass"></p>
    <p id="modalSession"></p>
    <img id="modalPassport" style="width:100px;margin-top:10px;">
    <div id="termLockWarning" class="term-warning hidden"></div>
    <h4>Results</h4>
    <table id="modalResultsTable" style="width:100%;border-collapse:collapse;"></table>
    <button id="downloadBtn" onclick="downloadResults()">Download Results</button>
  </div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyDyGAAiybGdSQZvsJnzK46fUtCMmcVwhP0",
  authDomain: "crescent-heights-oyo.firebaseapp.com",
  projectId: "crescent-heights-oyo",
  storageBucket: "crescent-heights-oyo.appspot.com", // <-- fixed
  messagingSenderId: "1067062273531",
  appId: "1:1067062273531:web:c90a74569e8fb2d18c175e"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

let allStudents = [];
let chartInstance = null;
let currentStudent = null;

// Switch views
window.show = id => {
  document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

// Create Student
window.createStudent = async () => {
  if(!cName.value || !cClass.value || !cPassport.files[0])
    return alert("All fields required");

  try {
    const matric = "CHO" + Date.now().toString().slice(-6);
    const file = cPassport.files[0];
    const storageRef = ref(storage,"passports/"+matric);

    await uploadBytes(storageRef,file);
    const imageURL = await getDownloadURL(storageRef);

    await addDoc(collection(db,"students"),{
      matric,
      name:cName.value,
      class:cClass.value,
      passport:imageURL,
      results:[],
      lockedTerm:null
    });

    createdMatric.innerHTML = "Matric: <b>"+matric+"</b>";
    cName.value=""; cClass.value=""; cPassport.value="";
    loadDashboard();

  } catch(err) {
    console.error(err);
    alert("Error creating student: " + err.message);
  }
}

// Add Result
window.addResult = async () => {
  if(!rMatric.value || !rSubject.value || !rScore.value)
    return alert("All fields required");

  const qSnap = await getDocs(query(collection(db,"students"), where("matric","==",rMatric.value)));

  if(qSnap.empty) return alert("Student not found");

  qSnap.forEach(async d => {
    const data = d.data();
    if(data.lockedTerm === rTerm.value) return alert("Term Locked");

    data.results.push({
      term: rTerm.value,
      subject: rSubject.value,
      score: Number(rScore.value)
    });

    await updateDoc(doc(db,"students",d.id), { results: data.results });
  });

  alert("Result Added");
  rMatric.value=""; rSubject.value=""; rScore.value="";
  loadDashboard();
}

// Load dashboard
async function loadDashboard(){
  const snap = await getDocs(collection(db,"students"));
  allStudents = [];
  let totalRes = 0;
  let classes = new Set();

  snap.forEach(d => {
    const s = d.data(); s.id = d.id;
    allStudents.push(s);
    classes.add(s.class);
    totalRes += s.results.length;
  });

  totalStudents.innerText = allStudents.length;
  totalClasses.innerText = classes.size;
  totalResults.innerText = totalRes;

  renderTable(allStudents);
  renderTopStudents();
  renderChart();
}

// Average
function calculateAverage(results){
  if(!results.length) return 0;
  return (results.reduce((a,b)=>a+b.score,0)/results.length).toFixed(1);
}

// Render student table
function renderTable(data){
  studentTable.innerHTML="<tr><th>Photo</th><th>Matric</th><th>Name</th><th>Class</th><th>Avg</th><th>Actions</th></tr>";
  data.forEach(s=>{
    studentTable.innerHTML += `
      <tr>
        <td><img src="${s.passport}" class="passport"></td>
        <td>${s.matric}</td>
        <td>${s.name}</td>
        <td>${s.class}</td>
        <td>${calculateAverage(s.results)}</td>
        <td>
          <button onclick="viewProfile('${s.id}')">View</button>
          <button onclick="deleteStudent('${s.id}')">Delete</button>
        </td>
      </tr>
    `;
  });
}

// View profile
window.viewProfile = async (id) => {
  const s = allStudents.find(st=>st.id===id);
  if(!s) return alert("Student not found");
  currentStudent = s;

  modalName.innerText = s.name;
  modalMatric.innerText = "Matric Number: "+s.matric;
  modalClass.innerText = "Class: "+s.class;
  modalSession.innerText = "Results: "+(s.results.length? s.results.length : "No results");
  modalPassport.src = s.passport;

  modalResultsTable.innerHTML = "<tr><th>Term</th><th>Subject</th><th>Score</th></tr>";
  s.results.forEach(r=>{
    modalResultsTable.innerHTML += `<tr><td>${r.term}</td><td>${r.subject}</td><td>${r.score}</td></tr>`;
  });

  if(s.lockedTerm){
    termLockWarning.innerText = `‚ö†Ô∏è Term "${s.lockedTerm}" is locked. No results can be added for this term.`;
    termLockWarning.classList.remove("hidden");
  }else{
    termLockWarning.classList.add("hidden");
  }

  profileModal.style.display = "block";
}

// Download CSV
window.downloadResults = () => {
  if(!currentStudent) return;
  if(!currentStudent.results.length) return alert("No results to download");

  let csvContent = "Term,Subject,Score\n";
  currentStudent.results.forEach(r=>{
    csvContent += `${r.term},${r.subject},${r.score}\n`;
  });

  const blob = new Blob([csvContent], { type: "text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `${currentStudent.matric}_results.csv`;
  link.click();
}

// Close modal
window.closeProfileModal = () => { profileModal.style.display="none"; }

// Delete student
window.deleteStudent = async (id) => {
  if(confirm("Delete student?")){
    await deleteDoc(doc(db,"students",id));
    loadDashboard();
  }
}

// Search
searchBox.oninput = () => {
  const val = searchBox.value.toLowerCase();
  renderTable(allStudents.filter(s =>
    s.name.toLowerCase().includes(val) || s.matric.toLowerCase().includes(val)
  ));
}

// Top students
function renderTopStudents(){
  const ranked = [...allStudents];
  ranked.sort((a,b)=>calculateAverage(b.results)-calculateAverage(a.results));
  topStudents.innerHTML="";
  ranked.slice(0,3).forEach((s,i)=>{
    topStudents.innerHTML += `<div class="top-student"><b>${i+1}. ${s.name}</b> - ${calculateAverage(s.results)}</div>`;
  });
}

// Chart
function renderChart(){
  const labels = allStudents.map(s=>s.name);
  const averages = allStudents.map(s=>calculateAverage(s.results));
  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(performanceChart,{
    type:'bar',
    data:{ labels, datasets:[{ label:'Average Score', data:averages }] },
    options:{ responsive:true, maintainAspectRatio:false }
  });
}

// Logout
window.logout = () => {
  localStorage.removeItem("teacherLoggedIn");
  window.location.href="login.html";
}

// Close modal on click outside
window.onclick = function(event) {
  if(event.target == profileModal) profileModal.style.display = "none";
}

loadDashboard();

</script>

</body>
</html>
